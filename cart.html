<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="/TechNova/styles/index.css" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #ffffff !important;
      }
      .cartlist_card h5,
      h4 {
        color: white;
        margin: 50px 0 0 10px;
      }
      h5 {
        color: black;
        margin: 20px 0 0 100px;
      }
      .cart_div {
        display: grid;
        justify-content: center;
        align-items: center;
      }
      .cartlist_card {
        width: 100%;
        height: max-content;
        color: white;
        border-radius: 10px;
        background-color: black;
        border: 1px solid rgb(224, 213, 213);
        text-align: center;
        margin: 20px 0 0 0;
      }

      .checkoutCard {
        width: 100%;
        height: max-content;
        color: white;
        border-radius: 10px;
        background-color: black;
        border: 1px solid rgb(224, 213, 213);
        text-align: center;
        margin: 20px 0 0 0;
      }
      .cartlist_card img {
        margin: 50px 0 0 0;
        width: 100%;
        height: 50%;
      }
      .cartlist_card button,
      .checkoutCard button {
        margin: 50px 0 50px 10px;
        width: 150px;
        height: 50px;
        background-color: #12daa8;
        color: white;
        border-radius: 5px;
      }
      .cartlist_card .price-and-rating {
        display: flex;
        align-items: center;
        margin: 50px 0 0 0;
      }

      .cartlist_card .product-price {
        margin-right: 20px; /* Space between the price and the stars */
      }

      .cartlist_card .star-rating {
        display: flex;
        gap: 5px; /* Space between the stars */
      }

      .cartlist_card .star {
        width: 40px; /* Adjust size as needed */
        height: 40px; /* Adjust size as needed */
        margin: 10px 0 0 0;
      }
      #couponBlock {
        background-color: BLACK;
        color: WHITE;
        height: 70px;
        width: 57%;
        margin: 50px 0 0 100px;
        text-align: start;
      }
    </style>
  </head>
  <body>
    <div id="nav"></div>

    <!-- main Offcanvas Menu -->
    <div
      class="offcanvas offcanvas-start text-bg-dark"
      tabindex="-1"
      id="mainMenu"
      aria-labelledby="mainMenuLabel"
    >
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="mainMenuLabel">Main Menu</h5>
        <button
          type="button"
          class="btn-close text-reset"
          data-bs-dismiss="offcanvas"
          aria-label="Close"
        ></button>
      </div>
      <div class="offcanvas-body">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="#">Exclusive At Croma</a>
          </li>
          <hr />
          <li class="nav-item dropdown dropend">
            <a
              class="nav-link dropdown-toggle"
              href="#"
              role="button"
              data-bs-toggle="dropdown"
              aria-expanded="false"
              >Top Brands</a
            >
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#">Brand 1</a></li>
              <li><a class="dropdown-item" href="#">Brand 2</a></li>
            </ul>
          </li>
          <hr />
          <li class="nav-item">
            <a class="nav-link" href="#">Croma Store Locator</a>
          </li>
          <li class="nav-item"><a class="nav-link" href="#">Gift Card</a></li>
        </ul>
      </div>
    </div>

    <!-- Account Offcanvas Menu -->
    <div
      class="offcanvas offcanvas-end text-bg-dark"
      tabindex="-1"
      id="accountMenu"
      aria-labelledby="accountMenuLabel"
    >
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="accountMenuLabel">Account</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="offcanvas"
          aria-label="Close"
        ></button>
      </div>
      <div class="offcanvas-body" id="loginBody" style="display: block">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a
              class="nav-link"
              href="#"
              data-bs-toggle="modal"
              data-bs-target="#LoginModalLabel"
            >
              <i class="bi bi-person-circle"></i> Profile
            </a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link"
              href="#"
              data-bs-toggle="modal"
              data-bs-target="#LoginModalLabel"
            >
              <img
                src="https://img.icons8.com/?size=100&id=14312&format=png&color=FFFFFF"
              />
              Address
            </a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link"
              href="#"
              data-bs-toggle="modal"
              data-bs-target="#LoginModalLabel"
            >
              <img
                src="https://img.icons8.com/?size=100&id=nmdLxlZq4cQi&format=png&color=FFFFFF"
              />
              Orders
            </a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link"
              href="#"
              data-bs-toggle="modal"
              data-bs-target="#LoginModalLabel"
            >
              <i class="bi bi-heart"></i> WishList
            </a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link"
              href="#"
              id="Login_Modal"
              data-bs-toggle="modal"
              data-bs-target="#LoginModalLabel"
              style="display: block"
            >
              <i class="bi bi-power"></i> Login
            </a>
          </li>
        </ul>
      </div>
      <div class="offcanvas-body1" id="logoutBody" style="display: none">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="./profile.html"
              ><i class="bi bi-person-circle"></i> Profile</a
            >
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#"
              ><img
                src="https://img.icons8.com/?size=100&id=14312&format=png&color=FFFFFF"
              />
              Address</a
            >
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#"
              ><img
                src="https://img.icons8.com/?size=100&id=nmdLxlZq4cQi&format=png&color=FFFFFF"
              />
              Orders</a
            >
          </li>
          <li class="nav-item">
            <a class="nav-link" href="./wishlist.html"
              ><i class="bi bi-heart"></i> WishList</a
            >
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" id="Logout_Modal"
              ><i class="bi bi-power"></i> Logout</a
            >
          </li>
        </ul>
      </div>
    </div>

    <!-- Login Modal -->
    <div
      class="modal fade"
      id="LoginModalLabel"
      tabindex="-1"
      aria-labelledby="Login_Modal_Label"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button
              type="button"
              id="close"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>

          <div class="modal-body" id="modal-body" style="display: block">
            <span>
              <h5 class="mt-4" style="color: rgb(25, 191, 141)">
                Login OR Create Account
              </h5>

              <h6 class="mt-4">Please enter your Email ID or Phone number</h6>

              <input
                type="text"
                class=""
                id="myInput2"
                placeholder="Enter your Email ID or phone number"
              />
              <div class="mb-3 form-check">
                <span class="form-check-group">
                  <input
                    type="checkbox"
                    class="form-check-input custom-checkbox"
                    id="exampleCheck1"
                  />
                  <label class="form-check-label" for="exampleCheck1"
                    >Keep me signed in</label
                  >
                </span>
              </div>

              <p>
                By continuing you agree to our <a href="">Terms of Use</a> &
                <a href="">Privacy Policy</a>
              </p>
              <br />
              <button type="button" id="signin" class="continue">
                Continue
              </button>
            </span>
          </div>
          <div class="modal-body" id="modal-body2" style="display: none">
            <span>
              <h5 class="mt-4" style="color: rgb(25, 191, 141)">
                Create Account
              </h5>

              <input
                type="text"
                class=""
                id="phonenumber"
                style="display: none"
                placeholder="Enter your phone number"
              />
              <input
                type="text"
                class=""
                id="emailId"
                style="display: none"
                placeholder="Enter your email"
              />

              <input
                type="text"
                class=""
                id="userpassword"
                placeholder="create password"
              />
              <input
                type="text"
                class=""
                id="confirm_password"
                placeholder="confirm password"
              />

              <div class="mb-3 form-check">
                <span class="form-check-group">
                  <input
                    type="checkbox"
                    class="form-check-input custom-checkbox"
                    id="exampleCheck1"
                  />
                  <label class="form-check-label" for="exampleCheck1"
                    >Keep me signed in</label
                  >
                </span>
              </div>

              <p>
                By continuing you agree to our <a href="">Terms of Use</a> &
                <a href="">Privacy Policy</a>
              </p>
              <br />
              <button type="button" id="signin2" class="continue">
                Continue
              </button>
            </span>
          </div>

          <div class="modal-body" id="modal-body3" style="display: none">
            <span>
              <h6 class="mt-4" style="display: none" id="mobileline">
                OTP is sent to your registered mobile no:xxxx
              </h6>
              <h6 class="mt-4" style="display: none" id="emailline">
                OTP is sent to your registered email :xxxx
              </h6>

              <h6 class="mt-4">Enter OTP</h6>

              <div class="otp-container">
                <div class="otp-inputs">
                  <input
                    type="text"
                    maxlength="1"
                    class="otp-input"
                    id="otp1"
                  />
                  <input type="text" maxlength="1" class="otp-input" />
                  <input type="text" maxlength="1" class="otp-input" />
                  <input type="text" maxlength="1" class="otp-input" />
                </div>
              </div>

              <p>
                By continuing you agree to our <a href="">Terms of Use</a> &
                <a href="">Privacy Policy</a>
              </p>
              <br />
              <button type="button" id="signin3" class="continue">
                Continue
              </button>
            </span>
          </div>
        </div>
      </div>
    </div>

    <div>
      <h4>YOUR CART</h4>
      <div id="couponBlock">
        <h4>APPLY COUPON</h4>
      </div>
    </div>

    <div class="cart_divs" id="cart_divs">
      <div class="container text-center">
        <div class="row">
          <div class="col cart_div col-8" id="cart_div"></div>
          <div class="col">
            <div class="checkoutCard">
              <h4>Order Summary</h4>
              <div>
                <span>
                  <h6>original price :</h6>
                  <h6 id="og_price"></h6>
                </span>
                <span>
                  <h6>Total price :</h6>
                  <h6 id="og_price2"></h6>
                </span>
              </div>
              <button id="checkoutBtn">Checkout</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const userID = sessionStorage.getItem("userID");

      if (!userID) {
        alert("User not logged in.");
        return;
      }
      const modalBody = document.getElementById("modal-body");
      const modalBody2 = document.getElementById("modal-body2");
      const modalBody3 = document.getElementById("modal-body3");

      login(userID);

      let logoutButton = document.getElementById("Logout_Modal");
      logoutButton.addEventListener("click", (event) => {
        logout(userID);
        // alert("clicked")
      });

      function login(userID) {
        if (userID) {
          sessionStorage.setItem("userID", userID);
          sessionStorage.setItem("isLoggedIn", "true");
          updateUI();
        } else {
          sessionStorage.setItem("isLoggedIn", "false");
        }
        // console.log(userID)

        modalBody.style.display = "block";
      }

      function updateUI() {
        const isLoggedIn = sessionStorage.getItem("isLoggedIn");

        const offcanvasBody = document.getElementById("loginBody");
        const offcanvas = document.getElementById("logoutBody");

        if (isLoggedIn === "true") {
          offcanvasBody.style.display = "none";
          offcanvas.style.display = "block";
          // console.log(isLoggedIn)
        } else {
          offcanvasBody.style.display = "block";
          offcanvas.style.display = "none";
          // console.log(isLoggedIn);
        }
      }

      function logout() {
        sessionStorage.clear();
        updateUI();
      }

      fetchAndDisplayCart(userID);

      // Cart event listener
      document
        .getElementById("cart_div")
        .addEventListener("click", handleCartActions);
    });

    // Fetch and display user's cart items
    function fetchAndDisplayCart(userID) {
      fetch("https://gregarious-dolomite-explanation.glitch.me/TechNovaUsers")
        .then((res) => res.json())
        .then((users) => {
          const user = users.find((user) => user.id == userID);
          if (user) {
            console.log(user);
            displayCartItems(user.cartlist);
          } else {
            console.log(user);

            alert("User cart is empty.");
          }
        })
        .catch((err) => console.error("Error fetching users:", err));
    }

    // Display cart items in the UI
    function displayCartItems(cartlist) {
      const cartDiv = document.getElementById("cart_div");
      if (cartDiv) {
        cartlist.forEach((product) => {
          fetchProductData(product)
            .then((productCard) => (cartDiv.innerHTML += productCard))
            .catch((err) => console.error("Error fetching product data:", err));
        });
      }
    }

    // Fetch product data and return a formatted card
    function fetchProductData(product) {
      return fetch(
        `https://gregarious-dolomite-explanation.glitch.me/category_Products?product_Type=${product.product_Type}&id=${product.product_type_id}`
      )
        .then((res) => res.json())
        .then((ProductTypeCards) => {
          return createCartCard(ProductTypeCards[0]); // Assuming only one card per product
        });
    }

    // Create a cart card HTML
    function createCartCard(product) {
      return `
    <div class="cartlist_card">
      <div class="container text-center">
        <div class="row">
          <div class="col">
            <img src="${product.image_url}" alt="${product.product_Brand} ${
        product.brand_model
      }">
            <input class="productID" value="${product.id}" hidden>
          </div>
          <div class="col">
            <h5>${product.desc}</h5>
            <h4 class="product-price"> ₹${product.price}</h4>
            <div class="star-rating">${createStarRating(5)}</div>
            <button class="removeBtn">Remove</button>
            <button class="cartBtn">Move To Wishlist</button>
          </div>
        </div>
      </div>
    </div>
  `;
    }

    // Create star rating HTML
    function createStarRating(rating) {
      const fullStar = `<img class="star" src="https://img.icons8.com/emoji/50/000000/star-emoji.png">`;
      const emptyStar = `<img class="star" src="https://img.icons8.com/emoji/50/000000/star-emoji.png">`;
      return fullStar.repeat(rating) + emptyStar.repeat(5 - rating);
    }

    // Handle cart actions (Remove/Move to Wishlist)
    function handleCartActions(event) {
      if (event.target.classList.contains("removeBtn")) {
        handleRemoveFromCart(event);
      } else if (event.target.classList.contains("cartBtn")) {
        handleMoveToWishlist(event);
      }
    }

    // Handle removing an item from the cart
    function handleRemoveFromCart(event) {
      const userID = sessionStorage.getItem("userID");

      const productId = event.target
        .closest(".cartlist_card")
        .querySelector(".productID").value;
      updateUserCart(
        userID,
        (user) => {
          const updatedCart = user.cartlist.filter(
            (item) => item.product_type_id !== productId
          );
          return { cartlist: updatedCart };
        },
        () => event.target.closest(".cartlist_card").remove()
      );
    }

    // Handle adding an item to the cart
    function handleMoveToWishlist(event) {
      const productId = event.target
        .closest(".cartlist_card")
        .querySelector(".productID").value;
      updateUserCart(userID, (user) => {
        const cartObj = { product_Type: productId };
        user.cartlist.push(cartObj);
        return { cartlist: user.cartlist };
      });
    }

    // Update the user cart with PATCH request
    function updateUserCart(userID, modifyCart, onSuccess) {
      fetch(
        `https://gregarious-dolomite-explanation.glitch.me/TechNovaUsers/${userID}`
      )
        .then((res) => res.json())
        .then((user) => {
          const updatedData = modifyCart(user);
          return fetch(
            `https://gregarious-dolomite-explanation.glitch.me/TechNovaUsers/${userID}`,
            {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(updatedData),
            }
          );
        })
        .then((res) => {
          if (res.ok) {
            alert("Cart updated successfully!");
            if (onSuccess) onSuccess();
          } else {
            alert("Failed to update cart.");
          }
        })
        .catch((err) => console.error("Error updating cart:", err));
    }

    // Handle checkout action
    document.getElementById("checkoutBtn").addEventListener("click", () => {
      const userID = sessionStorage.getItem("userID");
      prompt("Are you sure to checkout?");
      updateUserCart(
        userID,
        (user) => {
          user.cartlist = [];
          return { cartlist: user.cartlist };
        },
        () => {
          alert("Thanks For Shopping!");
          resetCartUI();
        }
      );
    });

    // Reset UI after checkout
    function resetCartUI() {
      document.getElementById("cart_div").innerHTML = "";
      document.getElementById("og_price").innerHTML = "₹0";
      document.getElementById("og_price2").innerHTML = "₹0";
    }
  </script>
  <script src="/TechNova/scripts/navbar.js"></script>
  <!-- <script src="/TechNova/scripts/functions.js"></script> -->

  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>
</html>
